<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Timebox Planner</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#4f46e5" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 8px 24px rgba(0,0,0,.06);
      --indigo:#4f46e5;
      --purple:#7c3aed;
      --blue:#2563eb;
      --red:#ef4444;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .quote{
      background: linear-gradient(90deg, var(--indigo), var(--purple));
      color:#fff;border-radius:14px;padding:14px 16px;
      box-shadow:var(--shadow); text-align:center; font-weight:700;
      margin-bottom:12px;
    }
    .card{
      background:var(--card);border-radius:var(--radius);
      box-shadow:var(--shadow); padding:14px; margin-bottom:12px;
    }
    .row{display:flex;align-items:center;gap:10px}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .btn{
      border:0;background:transparent; padding:10px; border-radius:12px;
      display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
    }
    .btn:hover{background:#f3f4f6}
    .btn-indigo:hover{background:#eef2ff}
    .h1{font-size:22px;margin:0;font-weight:800}
    .section-title{
      display:flex;align-items:center;gap:8px;
      font-weight:800; letter-spacing:.3px;
    }
    .grid{
      display:grid;grid-template-columns: 1fr; gap:12px;
    }
    @media (min-width: 1024px){
      .grid{grid-template-columns: 1fr 2fr;}
    }
    .subgrid{display:grid;grid-template-columns:1fr; gap:12px;}
    .todo-empty{color:#9ca3af;font-size:13px;text-align:center;padding:14px 0}
    .todo-row{
      display:flex;align-items:center;gap:10px;
      padding:6px 6px;border-radius:12px;
    }
    .todo-row.active{background:#f9fafb}
    .todo-text{
      flex:1; border:0; border-bottom:1px solid var(--border);
      padding:6px 6px; outline:none; background:transparent;
      font-size:14px;
    }
    .todo-text:focus{border-bottom-color:#fca5a5}
    .chk{width:20px;height:20px}
    .trash-btn{padding:10px;border-radius:12px}
    .trash-btn:hover{background:#fff1f2}
    textarea{
      width:100%; border:1px solid var(--border);
      border-radius:14px; padding:12px; outline:none; resize:none;
      font-size:14px; min-height:220px;
    }
    textarea:focus{border-color:#c4b5fd}
    /* TIME PLAN */
    .timeplan{
      border:1px solid #d1d5db; border-radius:14px; overflow:hidden;
    }
    .tp-row{
      display:grid; grid-template-columns: 88px 1fr;
      border-top:1px solid var(--border);
    }
    .tp-row.hour{border-top:2px solid #d1d5db}
    .tp-time{
      padding:8px 10px; font-size:13px; color:var(--muted);
      display:flex; align-items:center; background:#f9fafb;
      font-weight:700;
    }
    .tp-time.work{background:#eff6ff}
    .tp-input{
      border:0; outline:none; padding:8px 10px; font-size:13px;
      background:transparent;
    }
    .tp-input:focus{background:#fffbeb}
    .tp-cell.work{background:rgba(239,246,255,.45)}
    /* Stats */
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center}
    .stat-label{font-size:12px;color:var(--muted)}
    .stat-val{font-size:24px;font-weight:900;margin-top:4px}
    .green{color:#16a34a}
    .red{color:#dc2626}

    /* Modal */
    .modal-back{
      position:fixed; inset:0; background:rgba(0,0,0,.5);
      display:flex; align-items:center; justify-content:center;
      padding:16px; z-index:9999;
    }
    .modal{
      width:min(720px, 100%); background:#fff; border-radius:22px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      padding:18px;
      max-height: 86vh; overflow:auto;
    }
    .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .cal-title{font-size:18px;font-weight:900}
    .dow{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:8px 0}
    .dow div{font-size:12px;color:var(--muted);text-align:center;font-weight:800}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{
      aspect-ratio:1/1;border:0;border-radius:12px;background:transparent;
      cursor:pointer; position:relative;
      display:flex;align-items:center;justify-content:center;
      font-weight:800;
    }
    .day:hover{background:#f3f4f6}
    .day.today{background:#eef2ff;color:#3730a3}
    .day.sel{background:var(--indigo);color:#fff}
    .dot{position:absolute;bottom:6px;width:6px;height:6px;border-radius:999px;background:var(--indigo)}
    .goal-title{font-weight:900;margin:12px 0 8px}
    .goal-area{
      border:2px solid #c7d2fe; border-radius:14px; padding:10px;
      outline:none; width:100%; min-height:86px; resize:none;
    }
    .goal-area.purple{border-color:#ddd6fe}
    .close-btn{
      width:100%; margin-top:12px;
      border:0; background:var(--indigo); color:#fff;
      padding:12px; border-radius:14px; font-weight:900; cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .close-btn:hover{filter:brightness(.95)}
    /* Icons */
    .ico{width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
    .c-gray{color:#374151}
    .c-indigo{color:#4f46e5}
    .c-red{color:#ef4444}
    .c-blue{color:#2563eb}
    .c-purple{color:#7c3aed}
  </style>
</head>

<body>
  <div class="wrap">
    <div id="quote" class="quote">Ïò§ÎäòÎèÑ Î©ãÏßÑ ÌïòÎ£® ÎêòÏÑ∏Ïöî! üéØ</div>

    <!-- Header -->
    <div class="card">
      <div class="row-between">
        <button id="prevDay" class="btn" aria-label="Ïù¥Ï†Ñ ÎÇ†Ïßú">
          <svg class="ico c-gray" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
        </button>

        <div class="row">
          <button id="openCal1" class="btn btn-indigo" aria-label="Îã¨Î†• Ïó¥Í∏∞">
            <svg class="ico c-indigo" viewBox="0 0 24 24">
              <path d="M8 2v4M16 2v4"/><path d="M3 10h18"/><path d="M5 6h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"/>
            </svg>
          </button>

          <button id="openCal2" class="btn" style="padding:6px 10px" aria-label="Îã¨Î†• Ïó¥Í∏∞">
            <h1 id="dateTitle" class="h1">1Ïõî 14Ïùº (Ïàò)</h1>
          </button>
        </div>

        <button id="nextDay" class="btn" aria-label="Îã§Ïùå ÎÇ†Ïßú">
          <svg class="ico c-gray" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
        </button>
      </div>
    </div>

    <div class="grid">
      <!-- Left -->
      <div class="subgrid">

        <!-- TODO -->
        <div class="card">
          <div class="row-between" style="margin-bottom:10px">
            <div class="section-title">
              <svg class="ico c-red" viewBox="0 0 24 24">
                <path d="M8 6h13"/><path d="M8 12h13"/><path d="M8 18h13"/><path d="M3 6h.01"/><path d="M3 12h.01"/><path d="M3 18h.01"/>
              </svg>
              <div>TO DO LIST</div>
            </div>
            <button id="addTodo" class="btn" aria-label="Ìï† Ïùº Ï∂îÍ∞Ä">
              <svg class="ico c-gray" viewBox="0 0 24 24"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
            </button>
          </div>

          <div id="todoList"></div>
        </div>

        <!-- BRAIN DUMP -->
        <div class="card">
          <div class="section-title" style="margin-bottom:10px">
            <svg class="ico c-purple" viewBox="0 0 24 24">
              <path d="M9.5 2a3.5 3.5 0 0 0-3.2 5.1A3.5 3.5 0 0 0 6 14.5V16a2 2 0 0 0 2 2h1"/>
              <path d="M14.5 2a3.5 3.5 0 0 1 3.2 5.1A3.5 3.5 0 0 1 18 14.5V16a2 2 0 0 1-2 2h-1"/>
              <path d="M10 22v-2"/><path d="M14 22v-2"/>
            </svg>
            <div>BRAIN DUMP</div>
          </div>
          <textarea id="brainDump" placeholder="Îñ†Ïò§Î•¥Îäî ÏÉùÍ∞Å, ÏïÑÏù¥ÎîîÏñ¥Î•º ÏûêÏú†Î°≠Í≤å Ï†ÅÏñ¥Î≥¥ÏÑ∏Ïöî..."></textarea>
        </div>

      </div>

      <!-- Right -->
      <div class="card">
        <div class="section-title" style="margin-bottom:10px">
          <svg class="ico c-blue" viewBox="0 0 24 24">
            <path d="M12 6v6l4 2"/><path d="M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0z"/>
          </svg>
          <div>TIME PLAN</div>
        </div>

        <div id="timePlan" class="timeplan"></div>
      </div>
    </div>

    <!-- Stats -->
    <div class="card">
      <div class="stats">
        <div>
          <div class="stat-label">Ï†ÑÏ≤¥ Ìï† Ïùº</div>
          <div id="statTotal" class="stat-val">0</div>
        </div>
        <div>
          <div class="stat-label">ÏôÑÎ£å</div>
          <div id="statDone" class="stat-val green">0</div>
        </div>
        <div>
          <div class="stat-label">ÎÇ®ÏùÄ Ìï† Ïùº</div>
          <div id="statLeft" class="stat-val red">0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar Modal (hidden by default) -->
  <div id="modalBack" class="modal-back" style="display:none">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="cal-head">
        <button id="calPrev" class="btn" aria-label="Ïù¥Ï†Ñ Îã¨">
          <svg class="ico c-gray" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <div id="calTitle" class="cal-title">2026ÎÖÑ 1Ïõî</div>
        <button id="calNext" class="btn" aria-label="Îã§Ïùå Îã¨">
          <svg class="ico c-gray" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
        </button>
      </div>

      <div class="dow">
        <div>Ïùº</div><div>Ïõî</div><div>Ìôî</div><div>Ïàò</div><div>Î™©</div><div>Í∏à</div><div>ÌÜ†</div>
      </div>

      <div id="calGrid" class="cal-grid"></div>

      <div class="goal-title" id="yearGoalTitle">üéØ 2026ÎÖÑ Î™©Ìëú</div>
      <textarea id="yearGoal" class="goal-area" placeholder="Ïò¨Ìï¥Ïùò Î™©ÌëúÎ•º Ï†ÅÏñ¥Î≥¥ÏÑ∏Ïöî..."></textarea>

      <div class="goal-title" id="monthGoalTitle">üìã 1Ïõî Î™©Ìëú</div>
      <textarea id="monthGoal" class="goal-area purple" placeholder="Ïù¥Î≤à Îã¨Ïùò Î™©ÌëúÎ•º Ï†ÅÏñ¥Î≥¥ÏÑ∏Ïöî..."></textarea>

      <button id="closeModal" class="close-btn">
        <svg class="ico" style="color:#fff" viewBox="0 0 24 24"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
        Îã´Í∏∞
      </button>
    </div>
  </div>

<script>
/* =========================
   Simple Timebox Planner
   - No React, No build
   - GitHub Pages friendly
========================= */

const QUOTES = [
  "Ïò§Îäò ÌïòÎ£®ÎèÑ ÏµúÏÑ†ÏùÑ Îã§Ìï¥Î¥êÏöî! üí™",
  "ÏûëÏùÄ ÏßÑÏ†ÑÎèÑ ÏßÑÏ†ÑÏûÖÎãàÎã§! üåü",
  "ÎãπÏã†ÏùÄ Ìï† Ïàò ÏûàÏñ¥Ïöî! ‚ú®",
  "Ïò§ÎäòÎèÑ Î©ãÏßÑ ÌïòÎ£® ÎêòÏÑ∏Ïöî! üéØ",
  "Ìïú Í±∏Ïùå Ìïú Í±∏Ïùå, Ï∞®Í∑ºÏ∞®Í∑º! üöÄ",
  "ÎãπÏã†Ïùò ÎÖ∏Î†•ÏùÄ ÎπõÏùÑ Î∞úÌï† Í±∞ÏòàÏöî! üí´",
  "Ïò§ÎäòÏùò ÎãπÏã†ÏùÑ ÏùëÏõêÌï©ÎãàÎã§! üåà",
  "ÏôÑÎ≤ΩÌïòÏßÄ ÏïäÏïÑÎèÑ Í¥úÏ∞ÆÏïÑÏöî! üíù",
  "Ìï† Ïàò ÏûàÎã§Îäî ÎØøÏùåÏù¥ Î∞òÏûÖÎãàÎã§! üåª",
  "Ïò§Îäò ÌïòÎ£®Î•º Ï¶êÍ≤®Î¥êÏöî! üé®"
];

const TIME_SLOTS = [
  '05:00','05:30','06:00','06:30','07:00','07:30','08:00','08:30',
  '09:00','09:30','10:00','10:30','11:00','11:30','12:00','12:30',
  '13:00','13:30','14:00','14:30','15:00','15:30','16:00','16:30',
  '17:00','17:30','18:00','18:30','19:00','19:30','20:00','20:30',
  '21:00','21:30','22:00','22:30','23:00','23:30','00:00','00:30',
  '01:00','01:30','02:00','02:30','03:00','03:30','04:00','04:30'
];

// storage keys
const K_DAILY = "tbp_dailyData_v1";
const K_YEAR  = "tbp_yearGoals_v1";
const K_MONTH = "tbp_monthGoals_v1";

const $ = (id) => document.getElementById(id);

// State
let selectedDate = isoDate(new Date());
let calendarMonth = new Date(); // month currently shown in modal
let activeTodoId = null;

let dailyData = loadJSON(K_DAILY, {});
let yearlyGoals = loadJSON(K_YEAR, {});
let monthlyGoals = loadJSON(K_MONTH, {});

// Init
setQuote();
renderAll();
bindEvents();

// --- Helpers
function focusTodoInput(id){
  // Î†åÎçî ÌõÑ Ìï¥Îãπ inputÏùÑ Îã§Ïãú Ï∞æÏïÑ Ìè¨Ïª§Ïä§Î•º Î≥µÍµ¨(Î™®Î∞îÏùº Î¨ºÎ∞©Ïö∏/Ïª§ÏÑúÌï∏Îì§ Ìè¨Ìï®)
  requestAnimationFrame(() => {
    const row = document.querySelector(`[data-todo-row="1"][data-id="${id}"]`);
    const input = row?.querySelector(`input[data-act="text"]`);
    if(!input) return;
    input.focus({ preventScroll: true });
    // Ïª§ÏÑúÎ•º Îß® Îí§Î°ú
    const v = input.value ?? "";
    input.setSelectionRange(v.length, v.length);
  });
}  
function isoDate(d){
  const dt = new Date(d);
  dt.setHours(12,0,0,0); // avoid timezone edge
  return dt.toISOString().slice(0,10);
}
function loadJSON(key, fallback){
  try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
  catch { return fallback; }
}
function saveJSON(key, val){
  localStorage.setItem(key, JSON.stringify(val));
}
function daysKR(){ return ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†']; }
function formatDateKR(iso){
  const d = new Date(iso + "T12:00:00");
  const m = d.getMonth()+1;
  const day = d.getDate();
  const dow = daysKR()[d.getDay()];
  return `${m}Ïõî ${day}Ïùº (${dow})`;
}
function getToday(){
  return dailyData[selectedDate] || { todos: [], timeplan: {}, braindump: "" };
}
function setToday(updates){
  dailyData[selectedDate] = { ...getToday(), ...updates };
  saveJSON(K_DAILY, dailyData);
}
function hasData(dateStr){
  const d = dailyData[dateStr];
  if(!d) return false;
  return (d.todos && d.todos.length) || (d.timeplan && Object.keys(d.timeplan).length) || (d.braindump && d.braindump.trim());
}
function setQuote(){
  const q = QUOTES[Math.floor(Math.random()*QUOTES.length)];
  $("quote").textContent = q;
}

// --- Rendering
function renderAll(){
  $("dateTitle").textContent = formatDateKR(selectedDate);
  renderTodos();
  renderBrain();
  renderTimePlan();
  renderStats();
}
function renderTodos(){
  const wrap = $("todoList");
  const data = getToday();
  const todos = data.todos || [];

  if(todos.length === 0){
    wrap.innerHTML = `<div class="todo-empty">Ìï† ÏùºÏùÑ Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî</div>`;
    return;
  }

  wrap.innerHTML = todos.map(t => {
    const active = (activeTodoId === t.id) ? "active" : "";
    const checked = t.completed ? "checked" : "";
    const line = t.completed ? "style='text-decoration:line-through;color:#9ca3af'" : "";
    return `
      <div class="todo-row ${active}" data-todo-row="1" data-id="${t.id}">
        <input class="chk" type="checkbox" ${checked} data-act="toggle" />
        <input class="todo-text" type="text" value="${escapeHTML(t.text||"")}" placeholder="Ìï† Ïùº ÏûÖÎ†•" data-act="text" ${line}/>
        ${
          activeTodoId === t.id
          ? `<button class="btn trash-btn" data-act="del" aria-label="ÏÇ≠Ï†ú">
               <svg class="ico c-red" viewBox="0 0 24 24">
                 <path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/>
               </svg>
             </button>`
          : `<div style="width:44px"></div>`
        }
      </div>
    `;
  }).join("");
}
function renderBrain(){
  $("brainDump").value = getToday().braindump || "";
}
function renderTimePlan(){
  const host = $("timePlan");
  const data = getToday();
  const tp = data.timeplan || {};

  host.innerHTML = TIME_SLOTS.map(time => {
    const hour = parseInt(time.split(":")[0], 10);
    const isHour = time.endsWith(":00");
    const isWork = (hour >= 9 && hour < 18);
    const clsRow = `tp-row ${isHour ? "hour":""}`;
    const clsTime = `tp-time ${isWork ? "work":""}`;
    const clsCell = `tp-cell ${isWork ? "work":""}`;
    const label = isHour ? time : "";
    const val = tp[time] || "";
    const ph = isHour ? "ÏùºÏ†ï ÏûÖÎ†•" : "";
    return `
      <div class="${clsRow}" data-time="${time}">
        <div class="${clsTime}">${label}</div>
        <div class="${clsCell}">
          <input class="tp-input" value="${escapeHTML(val)}" placeholder="${ph}" />
        </div>
      </div>
    `;
  }).join("");
}
function renderStats(){
  const todos = (getToday().todos || []);
  const total = todos.length;
  const done = todos.filter(t=>t.completed).length;
  const left = total - done;
  $("statTotal").textContent = total;
  $("statDone").textContent = done;
  $("statLeft").textContent = left;
}

// --- Events
function bindEvents(){
  $("prevDay").addEventListener("click", ()=> changeDate(-1));
  $("nextDay").addEventListener("click", ()=> changeDate(1));
  $("openCal1").addEventListener("click", openCalendar);
  $("openCal2").addEventListener("click", openCalendar);

  $("addTodo").addEventListener("click", addTodo);

  // Todo delegation
  // Todo delegation (FIXED)
$("todoList").addEventListener("click", (e) => {
  const row = e.target.closest?.("[data-todo-row='1']");
  if (!row) return;

  const id = Number(row.dataset.id);

  // ‚úÖ ÏûÖÎ†•Ïπ∏/Ï≤¥ÌÅ¨Î∞ïÏä§/ÏÇ≠Ï†úÎ≤ÑÌäºÏùÑ ÎàÑÎ•º ÎïåÎäî Ïó¨Í∏∞ÏÑú "Ï¶âÏãú Ïû¨Î†åÎçî"ÌïòÏßÄ ÏïäÏùå
  // (Ï¶âÏãú Ïû¨Î†åÎçîÌïòÎ©¥ Ìè¨Ïª§Ïä§Í∞Ä ÎÇ†ÏïÑÍ∞ÄÏÑú ÏûÖÎ†•Ïù¥ ÏïàÎê®)
  const isInput = e.target.matches("input");
  const isButton = e.target.closest("button");
  if (isInput || isButton) return;

  activeTodoId = id;
  renderTodos();
});

$("todoList").addEventListener("focusin", (e) => {
  const row = e.target.closest?.("[data-todo-row='1']");
  if (!row) return;

  const id = Number(row.dataset.id);

  // ‚úÖ ÏûÖÎ†•Ïπ∏ÏùÑ ÌÑ∞ÏπòÌïòÎ©¥ activeÎ°ú ÎßåÎì§Í≥†(Ìú¥ÏßÄÌÜµ Î≥¥Ïù¥Í≤å),
  // ‚úÖ Ïû¨Î†åÎçî ÌõÑ Îã§Ïãú Ìè¨Ïª§Ïä§Î•º Î≥µÍµ¨Ìï¥ÏÑú ÌååÎûÄ Î¨ºÎ∞©Ïö∏(Ïª§ÏÑúÌï∏Îì§)Ïù¥ ÏûÖÎ†•Ïπ∏Ïóê Îú®Í≤å Ìï®
  if (activeTodoId !== id) {
    activeTodoId = id;
    renderTodos();
    focusTodoInput(id);
  }
});

$("todoList").addEventListener("change", (e) => {
  const row = e.target.closest?.("[data-todo-row='1']");
  if (!row) return;

  const id = Number(row.dataset.id);

  if (e.target.dataset.act === "toggle") {
    toggleTodo(id, e.target.checked);
  }
});

$("todoList").addEventListener("input", (e) => {
  const row = e.target.closest?.("[data-todo-row='1']");
  if (!row) return;

  const id = Number(row.dataset.id);

  if (e.target.dataset.act === "text") {
    updateTodoText(id, e.target.value);
  }
});

$("todoList").addEventListener("click", (e) => {
  const delBtn = e.target.closest?.("[data-act='del']");
  if (!delBtn) return;

  const row = e.target.closest("[data-todo-row='1']");
  const id = Number(row.dataset.id);
  deleteTodo(id);
  e.stopPropagation();
});


  // Click outside todo to hide trash
  document.addEventListener("click", (e)=>{
    const insideTodo = e.target.closest?.("[data-todo-row='1']");
    const insideAdd = e.target.closest?.("#addTodo");
    if(!insideTodo && !insideAdd){
      if(activeTodoId !== null){
        activeTodoId = null;
        renderTodos();
      }
    }
  });

  // Brain dump
  $("brainDump").addEventListener("input", (e)=>{
    setToday({ braindump: e.target.value });
  });

  // Time plan input delegation
  $("timePlan").addEventListener("input", (e)=>{
    const row = e.target.closest?.("[data-time]");
    if(!row) return;
    const time = row.dataset.time;
    const tp = { ...(getToday().timeplan || {}) };
    tp[time] = e.target.value;
    setToday({ timeplan: tp });
  });

  // Modal
  $("closeModal").addEventListener("click", closeCalendar);
  $("modalBack").addEventListener("click", (e)=>{
    if(e.target.id === "modalBack") closeCalendar();
  });

  $("calPrev").addEventListener("click", ()=> changeCalMonth(-1));
  $("calNext").addEventListener("click", ()=> changeCalMonth(1));

  $("yearGoal").addEventListener("input", (e)=>{
    const y = String(calendarMonth.getFullYear());
    yearlyGoals[y] = e.target.value;
    saveJSON(K_YEAR, yearlyGoals);
  });

  $("monthGoal").addEventListener("input", (e)=>{
    const key = monthKey(calendarMonth);
    monthlyGoals[key] = e.target.value;
    saveJSON(K_MONTH, monthlyGoals);
  });
}

function changeDate(delta){
  const d = new Date(selectedDate + "T12:00:00");
  d.setDate(d.getDate()+delta);
  selectedDate = isoDate(d);
  activeTodoId = null;
  renderAll();
}

function addTodo(){
  const data = getToday();
  const todos = data.todos || [];
  const t = { id: Date.now(), text: "", completed:false };
  todos.push(t);
  setToday({ todos });
  activeTodoId = t.id;
  renderTodos();
  renderStats();
  focusTodoInput(t.id); // ‚úÖ Ï∂îÍ∞Ä: ÏÉàÎ°ú ÎßåÎì† ÏûÖÎ†•Ïπ∏Ïóê Ïª§ÏÑú/Î¨ºÎ∞©Ïö∏ ÌëúÏãú
}

function toggleTodo(id, checked){
  const data = getToday();
  const todos = (data.todos || []).map(t => t.id===id ? {...t, completed:checked} : t);
  setToday({ todos });
  renderTodos();
  renderStats();
  // focusTodoInput(t.id);   // ‚úÖ Ï∂îÍ∞Ä: ÏÉà Ìï≠Î™© ÏûÖÎ†•Ïπ∏Ïóê Ïª§ÏÑú + ÌååÎûÄ Î¨ºÎ∞©Ïö∏ Îú∏
}

function updateTodoText(id, text){
  const data = getToday();
  const todos = (data.todos || []).map(t => t.id===id ? {...t, text} : t);
  setToday({ todos });
  renderStats();
}

function deleteTodo(id){
  const data = getToday();
  const todos = (data.todos || []).filter(t => t.id!==id);
  setToday({ todos });
  activeTodoId = null;
  renderTodos();
  renderStats();
}

// --- Calendar Modal
function openCalendar(){
  calendarMonth = new Date(selectedDate + "T12:00:00");
  calendarMonth.setDate(1);
  $("modalBack").style.display = "flex";
  renderCalendar();
}
function closeCalendar(){
  $("modalBack").style.display = "none";
}
function changeCalMonth(offset){
  const d = new Date(calendarMonth);
  d.setMonth(d.getMonth()+offset);
  calendarMonth = d;
  renderCalendar();
}
function monthKey(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function renderCalendar(){
  const y = calendarMonth.getFullYear();
  const m = calendarMonth.getMonth(); // 0-based
  $("calTitle").textContent = `${y}ÎÖÑ ${m+1}Ïõî`;

  // goals
  $("yearGoalTitle").textContent = `üéØ ${y}ÎÖÑ Î™©Ìëú`;
  $("monthGoalTitle").textContent = `üìã ${m+1}Ïõî Î™©Ìëú`;
  $("yearGoal").value = yearlyGoals[String(y)] || "";
  $("monthGoal").value = monthlyGoals[monthKey(calendarMonth)] || "";

  const first = new Date(y, m, 1);
  const last = new Date(y, m+1, 0);
  const daysInMonth = last.getDate();
  const startDow = first.getDay();

  const grid = $("calGrid");
  let html = "";

  for(let i=0;i<startDow;i++){
    html += `<div></div>`;
  }

  for(let day=1; day<=daysInMonth; day++){
    const d = new Date(y, m, day);
    const iso = isoDate(d);
    const isSel = (iso === selectedDate);
    const isToday = (iso === isoDate(new Date()));
    const cls = `day ${isSel ? "sel" : (isToday ? "today" : "")}`;
    const dot = (hasData(iso) && !isSel) ? `<div class="dot"></div>` : "";
    html += `<button class="${cls}" data-day="${day}">${day}${dot}</button>`;
  }
  grid.innerHTML = html;

  grid.querySelectorAll("button.day").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const day = Number(btn.dataset.day);
      const d = new Date(y, m, day);
      selectedDate = isoDate(d);
      closeCalendar();
      activeTodoId = null;
      renderAll();
    });
  });
}

// --- Safe HTML
function escapeHTML(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// Service Worker
if ("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}
</script>
</body>
</html>
